# ============================================
# COMPLETE PDF SUMMARIZER - RUN THIS ONE CELL
# ============================================

print("üöÄ Starting setup... Please wait!")
print("="*60)

# STEP 0: FORCEFULLY KILL EVERYTHING FIRST
print("\nüî® Killing all existing processes...")
import os
import time

os.system('killall -9 streamlit 2>/dev/null')
os.system('killall -9 ngrok 2>/dev/null')
os.system('pkill -9 -f streamlit 2>/dev/null')
os.system('pkill -9 -f ngrok 2>/dev/null')
time.sleep(5)  # Wait longer for cleanup
print("‚úÖ All processes killed!")

# STEP 1: Install all packages
print("\nüì¶ Step 1/4: Installing packages...")
import subprocess
import sys

packages = ['streamlit', 'langchain', 'langchain-community', 'pypdf', 'transformers', 'torch', 'pyngrok']
for package in packages:
    subprocess.check_call([sys.executable, "-m", "pip", "install", "-q", package])
print("‚úÖ Packages installed!")

# STEP 2: Configure ngrok (with cleanup)
print("\nüîë Step 2/4: Configuring ngrok...")
from pyngrok import ngrok, conf

# IMPORTANT: Replace with YOUR ngrok token
NGROK_TOKEN = "Your token"  # ‚Üê PASTE YOUR TOKEN HERE!

# Kill ngrok config and restart fresh
try:
    ngrok.kill()
    time.sleep(3)
except:
    pass

ngrok.set_auth_token(NGROK_TOKEN)
print("‚úÖ Ngrok configured!")

# STEP 3: Create app.py file
print("\nüìù Step 3/4: Creating app.py...")
app_code = '''import streamlit as st
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.document_loaders import PyPDFLoader
from transformers import T5Tokenizer, T5ForConditionalGeneration
from transformers import pipeline
import torch
import base64
import os

# Create data directory
os.makedirs('data', exist_ok=True)

#model and tokenizer loading
checkpoint = "MBZUAI/LaMini-Flan-T5-248M"
tokenizer = T5Tokenizer.from_pretrained(checkpoint)
base_model = T5ForConditionalGeneration.from_pretrained(checkpoint, device_map='auto', torch_dtype=torch.float32)

#file loader and preprocessing
def file_preprocessing(file):
    loader = PyPDFLoader(file)
    pages = loader.load_and_split()
    text_splitter = RecursiveCharacterTextSplitter(chunk_size=200, chunk_overlap=50)
    texts = text_splitter.split_documents(pages)
    final_texts = ""
    for text in texts:
        print(text)
        final_texts = final_texts + text.page_content
    return final_texts

#LLM pipeline
def llm_pipeline(filepath):
    pipe_sum = pipeline(
        'summarization',
        model = base_model,
        tokenizer = tokenizer,
        max_length = 500,
        min_length = 50)
    input_text = file_preprocessing(filepath)
    result = pipe_sum(input_text)
    result = result[0]['summary_text']
    return result

@st.cache_data
#function to display the PDF of a given file
def displayPDF(file):
    with open(file, "rb") as f:
        base64_pdf = base64.b64encode(f.read()).decode('utf-8')
    pdf_display = F'<iframe src="data:application/pdf;base64,{base64_pdf}" width="100%" height="600" type="application/pdf"></iframe>'
    st.markdown(pdf_display, unsafe_allow_html=True)

#streamlit code
st.set_page_config(layout="wide")

def main():
    st.title("Document Summarization App")
    uploaded_file = st.file_uploader("Upload your PDF file", type=['pdf'])
    
    if uploaded_file is not None:
        if st.button("Summarize"):
            col1, col2 = st.columns(2)
            filepath = "data/"+uploaded_file.name
            with open(filepath, "wb") as temp_file:
                temp_file.write(uploaded_file.read())
            with col1:
                st.info("Uploaded File")
                pdf_view = displayPDF(filepath)
            with col2:
                st.info("Processing... Please wait (3-5 minutes first time)")
                summary = llm_pipeline(filepath)
                st.info("Summarization Complete")
                st.success(summary)

if __name__ == "__main__":
    main()
'''

with open('app.py', 'w') as f:
    f.write(app_code)
print("‚úÖ app.py created!")

# STEP 4: Launch Streamlit with ngrok
print("\nüöÄ Step 4/4: Starting Streamlit...")

# Start Streamlit
from IPython import get_ipython
get_ipython().system_raw('streamlit run app.py --server.port 8501 --server.headless true > streamlit.log 2>&1 &')

print("‚è≥ Waiting for Streamlit to start (25 seconds)...")
time.sleep(25)

# Create NEW ngrok tunnel with fresh instance
print("üåê Creating ngrok tunnel...")
public_url = ngrok.connect(8501)

print("\n" + "="*60)
print("‚úÖ SUCCESS! Your app is LIVE!")
print("="*60)
print(f"\nüîó URL: {public_url}")
print("\nüìã INSTRUCTIONS:")
print("1. Copy the URL above")
print("2. Open it in a NEW browser tab")
print("3. Click 'Visit Site' on ngrok warning page")
print("4. Upload a PDF and click 'Summarize'")
print("\n‚ö†Ô∏è  FIRST TIME: Model download takes 3-5 minutes")
print("    Subsequent summaries take only 30-60 seconds")
print("="*60)
